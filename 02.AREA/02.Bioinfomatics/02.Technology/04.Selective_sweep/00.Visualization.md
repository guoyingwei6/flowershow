---
created: 2024-11-07 10:42
updated: 2025-06-10 09:54
dg-publish: true
tags:
  - garden/ğŸŒ±Seedling
---

```python
# -*- coding: utf-8 -*-
"""
Created on Mon Jan 15 20:28:05 2018
@author: Caiyd
"""

import json
import click
CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
import numpy as np
import pandas as pd
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import seaborn as sns
from itertools import cycle

import os
import sys
import logging
logging.basicConfig(filename='{0}.log'.format(os.path.basename(__file__).replace('.py','')),
                    format='%(asctime)s: %(name)s: %(levelname)s: %(message)s',level=logging.DEBUG,filemode='a')
logging.info("The command line is:\n\tpython3 {}".format(' '.join(sys.argv)))

def load_allchrom_data(infile, chr_col, loc_col, val_col, log_trans, neg_logtrans):
    """
    infile contain several chromosomes
    """
    df = pd.read_csv(infile,
                     sep='\t',
                     usecols = [chr_col, loc_col, val_col],
                     dtype={chr_col: str,
                            loc_col: float,
                            val_col: float})
    if log_trans:
        df.loc[:, val_col] = np.log10(df[val_col].values)
    elif neg_logtrans:
        df.loc[:, val_col] = -np.log10(df[val_col].values)
    df.dropna(inplace=True)
    return df


def plot(df, chr_col, loc_col, val_col, xlabel, ylabel, ylim, invert_yaxis, top_xaxis, cutoff, highlight, outfile, ticklabelsize, figsize, axlabelsize, markersize, fill_regions):
    sns.set_style('white', {'ytick.major.size': 3, 'xtick.major.size': 3})
    fig, ax = plt.subplots(1, 1, figsize=figsize)
#    offsets = {}
    loc_offset = 0
    xticks = []
    xticklabels = []

    # for fill_between
    valmax = df[val_col].max()
    valmin = df[val_col].min()
    if ylim:
        y1, y2 = ylim
    else:
        y1 = valmin
        y2 = valmax * 1.05

    # plot val
    for chrom, color in zip(df[chr_col].unique(), cycle(['#6a67a6', '#009384'])):   # '#191919', '#8e8e8e'
#        offsets[chrom] = loc_offset
        tmpdf = df.loc[df[chr_col]==chrom, [loc_col, val_col]]
        tmpdf[loc_col] += loc_offset
        xticklabels.append(chrom)
        xticks.append(tmpdf[loc_col].median())
        tmpdf.plot(kind='scatter', x=loc_col, y=val_col, ax=ax, s=markersize, color=color, marker='o')
        if isinstance(highlight, pd.DataFrame):
            hdf = highlight.loc[highlight[chr_col]==chrom, [loc_col, val_col]]
            if hdf.shape[0] > 0:
                hdf[loc_col] += loc_offset
                hdf.plot(kind='scatter', x=loc_col, y=val_col, ax=ax, s=markersize, color='#55A868', marker='o')
        if cutoff:
            ax.hlines(-np.log10(0.05/float(cutoff)), tmpdf[loc_col].values[0], tmpdf[loc_col].values[-1], color='gray', linestyle='--')

        # fill_between region
        if isinstance(fill_regions, pd.DataFrame):
            regions = fill_regions.loc[fill_regions['chrom']==chrom, ['start', 'end']].values
            if regions.shape[0] > 0:
                regions += loc_offset
                for region in regions:
                    # region: list [float, float]
                    ax.fill_between(region, y1, y2, color='grey', alpha=0.6)


        loc_offset = tmpdf[loc_col].values[-1] # assume loc is sorted
    ax.set_xlabel(xlabel, fontsize=axlabelsize)
    ax.set_ylabel(ylabel, fontsize=axlabelsize)
    plt.xticks(xticks, xticklabels)
    plt.subplots_adjust(left=0.05, right=0.99)
    ax.set_xlim([df[loc_col].values[0], tmpdf[loc_col].values[-1]])


    # adjust ylim
    if ylim:
        ax.set_ylim(ylim)

    # adjust axis
    if invert_yaxis:
        ax.invert_yaxis()
    if top_xaxis:
        ax.xaxis.tick_top()
        ax.spines['right'].set_visible(False)
        ax.spines['bottom'].set_visible(False)
        ax.xaxis.set_label_position('top')
    else:
        ax.spines['right'].set_visible(False)
        ax.spines['top'].set_visible(False)

    # adjust font size
    for label in (ax.get_xticklabels() + ax.get_yticklabels()):
        label.set_fontsize(ticklabelsize)
    plt.savefig(outfile, dpi=300)
    plt.close()


@click.command(context_settings=CONTEXT_SETTINGS)
@click.option('--infile', help='tsvæ–‡ä»¶,åŒ…å«header')
@click.option('--chr-col', help='æŸ“è‰²ä½“åˆ—å')
@click.option('--loc-col', help='xè½´å€¼åˆ—å')
@click.option('--val-col', help='yè½´å€¼åˆ—å')
@click.option('--log-trans', is_flag=True, default=False, help='å¯¹valåˆ—çš„å€¼å–ä»¥10ä¸ºåº•çš„å¯¹æ•°')
@click.option('--neg-logtrans', is_flag=True, default=False, help='å¯¹valåˆ—çš„å€¼å–ä»¥10ä¸ºåº•çš„è´Ÿå¯¹æ•°(ç”»på€¼)')
@click.option('--outfile', help='è¾“å‡ºæ–‡ä»¶,æ ¹æ®æ‹“å±•ååˆ¤æ–­è¾“å‡ºæ ¼å¼')
@click.option('--xlabel', help='è¾“å…¥æ•£ç‚¹å›¾xè½´æ ‡ç­¾çš„åç§°')
@click.option('--ylabel', help='è¾“å…¥æ•£ç‚¹å›¾yè½´æ ‡ç­¾çš„åç§°')
@click.option('--ylim', nargs=2, type=float, default=None, help='yè½´çš„æ˜¾ç¤ºèŒƒå›´,å¦‚0 1, é»˜è®¤ä¸é™å®š')
@click.option('--invert-yaxis',  is_flag=True, default=False, help='flag, ç¿»è½¬yè½´, é»˜è®¤ä¸ç¿»è½¬')
@click.option('--top-xaxis',  is_flag=True, default=False, help='flag, æŠŠxè½´ç½®äºé¡¶éƒ¨, é»˜è®¤åœ¨åº•éƒ¨')
@click.option('--cutoff', default=None, help='jsonæ ¼å¼çš„cutoff, è„šæœ¬cal_norm_isf.pyçš„è®¡ç®—ç»“æœ')
@click.option('--highlight', default=None, help='å’Œinfileç›¸åŒæ ¼å¼çš„æ–‡ä»¶,åœ¨è¯¥æ–‡ä»¶ä¸­çš„ç‚¹ä¼šåœ¨æ›¼å“ˆé¡¿å›¾ä¸­å•ç‹¬é«˜äº®å‡ºæ¥,default=None')
@click.option('--ticklabelsize', help='åˆ»åº¦æ–‡å­—å¤§å°', default=10)
@click.option('--figsize', nargs=2, type=float, help='å›¾åƒé•¿å®½, é»˜è®¤15 5', default=(15, 5))
@click.option('--axlabelsize', help='xè½´yè½´labelæ–‡å­—å¤§å°', default=10)
@click.option('--markersize', default=6, help='æ•£ç‚¹å¤§å°, default is 6', type=float)
@click.option('--chroms', default=None, help='åªç”¨è¿™äº›æŸ“è‰²ä½“,e.g --chr 6 --chr X will only plot chr6 and chrX.', multiple=True)
@click.option('--fill-regions', default=None, help='fill between regions in this <bed file> (no header)')
def main(infile, chr_col, loc_col, val_col, log_trans, neg_logtrans, outfile,
         xlabel, ylabel, ylim, invert_yaxis, top_xaxis, cutoff, highlight, ticklabelsize,
         figsize, axlabelsize, markersize, chroms, fill_regions):
    """
    \b
    æ›¼å“ˆé¡¿å›¾
    ä½¿ç”¨infileä¸­çš„chr_colå’Œloc_colåˆ—ä½œä¸ºxè½´, å¯¹åº”çš„val_colå€¼ç”»åœ¨yè½´
    è¾“å‡ºoutfile, æ ¹æ®outfileæŒ‡å®šçš„æ‹“å±•åè¾“å‡ºç›¸åº”çš„æ ¼å¼
    """
    print(__doc__)
    print(main.__doc__)
    df = load_allchrom_data(infile, chr_col, loc_col, val_col, log_trans, neg_logtrans)
    if chroms:
        print('use chroms:\n%s' % '\n'.join(chroms))
        chroms = set(chroms)
        df = df.loc[df[chr_col].isin(chroms), :]
    if highlight:
        highlight = load_allchrom_data(highlight, chr_col, loc_col, val_col, log_trans, neg_logtrans)
    if fill_regions:
        fill_regions = pd.read_csv(fill_regions, sep='\t', header=None, names=['chrom', 'start', 'end'],
                                   dtype={'chrom': str, 'start': float, 'end': float})
    if cutoff:
        cutoff=float(cutoff)
        #with open(cutoff) as f:
        #    cutoff = json.load(f)
    plot(df, chr_col, loc_col, val_col, xlabel, ylabel, ylim, invert_yaxis, top_xaxis, cutoff,
         highlight, outfile, ticklabelsize, figsize, axlabelsize, markersize, fill_regions)

if __name__ == '__main__':
    main()

```

